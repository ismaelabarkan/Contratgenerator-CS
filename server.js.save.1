

/**
 * Contract Generator Backend Server
 * Version: 4.3.0
 *
 * Clean entry point with modular architecture
 */

// Load environment variables first
require('dotenv').config();

const express = require('express');
const cors = require('cors');
const bodyParser = require('body-parser');
const path = require('path');

// Import configuration
const corsOptions = require('./backend/config/cors');
const { getDatabase, closeDatabase } = require('./backend/config/database');

// Import routes
const flowsRouter = require('./backend/routes/flows');
const clausulesRouter = require('./backend/routes/clausules');
const importRouter = require('./backend/routes/import');
const healthRouter = require('./backend/routes/health');

// Import middleware
const { errorHandler, notFoundHandler } = require('./backend/middleware/errorHandler');

// Initialize Express app
const app = express();
const PORT = process.env.PORT || 3001;

// ===== MIDDLEWARE =====
app.use(cors(corsOptions));
app.use(bodyParser.json());
app.use(express.static('public'));

// ===== ROUTES =====
// API routes
app.use('/api/flows', flowsRouter);
app.use('/api/clausules', clausulesRouter);
app.use('/api/import', importRouter);
app.use('/api/health', healthRouter);

// Serve admin interface
app.get('/', (req, res) => {
    res.sendFile(path.join(__dirname, 'beheer', 'flow-beheer.html'));
});

app.use(express.static(__dirname));


// ===== ERROR HANDLING =====
//404 handler (must be after all routes)
app.use(notFoundHandler);

// Error handler (must be last)
app.use(errorHandler);

// ===== START SERVER =====
// Only start server if not being required (i.e. not in test mode)
if (require.main === module) {
    // Initialize database connection
    getDatabase();

    // Start listening
    app.listen(PORT, () => {
        console.log(`
╔═══════════════════════════════════════════════════════╗
║     Contract Generator Backend - v4.3.0              ║
╠═══════════════════════════════════════════════════════╣
║  Server running on port ${PORT}                          ║
║  Environment: ${process.env.NODE_ENV || 'development'}                       ║
║                                                       ║
║  Endpoints:                                           ║
║   • http://localhost:${PORT}/                           ║
║   • http://localhost:${PORT}/api/health                 ║
║   • http://localhost:${PORT}/api/flows                  ║
║   • http://localhost:${PORT}/api/clausules              ║
║                                                       ║
║  Admin:                                               ║
║   • http://localhost:${PORT}/beheer/flow-beheer.html    ║
║   • http://localhost:${PORT}/beheer/clausule-beheer.html║
╚═══════════════════════════════════════════════════════╝
        `);
    });

    // ===== GRACEFUL SHUTDOWN =====
    process.on('SIGINT', () => {
        console.log('\nGracefully shutting down...');
        closeDatabase();
        process.exit(0);
    });

    process.on('SIGTERM', () => {
        console.log('\nGracefully shutting down...');
        closeDatabase();
        process.exit(0);
    });
}

// Export app for testing
module.exports = app;

